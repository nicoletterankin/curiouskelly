---
import type { LocaleDictionary } from '@lib/i18n/types';

interface Props {
  dictionary: LocaleDictionary;
  nonce: string;
}

const { dictionary, nonce } = Astro.props as Props;
---

<section class="testimonials" role="region" aria-labelledby="testimonials-title">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 id="testimonials-title" class="h5 mb-0">{dictionary.testimonials.title}</h2>
    <div class="d-flex gap-2" aria-hidden="true">
      <button type="button" class="btn btn-outline-primary btn-sm" data-carousel-prev>‹</button>
      <button type="button" class="btn btn-outline-primary btn-sm" data-carousel-next>›</button>
    </div>
  </div>
  <div class="testimonial-carousel" data-testimonials aria-roledescription="carousel">
    {dictionary.testimonials.items.map((testimonial, index) => (
      <article class="p-3" role="group" aria-label={`Slide ${index + 1}`}>
        <blockquote class="mb-3">“{testimonial.quote}”</blockquote>
        <p class="mb-0 fw-semibold">{testimonial.author}</p>
        {testimonial.role ? <p class="text-muted small mb-0">{testimonial.role}</p> : null}
      </article>
    ))}
  </div>
</section>
<script type="module" nonce={nonce} is:inline>
  import jQuery from 'jquery';
  import 'jquery-migrate/dist/jquery-migrate.min.js';
  import 'slick-carousel';

  // Ensure global assignment for legacy plugins
  window.jQuery = window.jQuery || jQuery;
  window.$ = window.$ || jQuery;

  const carousel = document.querySelector('[data-testimonials]');
  if (!carousel) {
    throw new Error('Testimonials carousel not found');
  }

  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const $carousel = jQuery(carousel);
  $carousel.slick({
    autoplay: !prefersReducedMotion,
    autoplaySpeed: 6000,
    adaptiveHeight: true,
    prevArrow: document.querySelector('[data-carousel-prev]'),
    nextArrow: document.querySelector('[data-carousel-next]'),
    dots: true,
    appendDots: jQuery('<div class="mt-3" />').appendTo(jQuery(carousel).parent()),
    accessibility: true
  });

  carousel.addEventListener('focusin', () => {
    $carousel.slick('slickPause');
  });
  carousel.addEventListener('focusout', () => {
    if (!prefersReducedMotion) {
      $carousel.slick('slickPlay');
    }
  });
</script>

